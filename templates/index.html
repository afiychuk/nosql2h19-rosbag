<!doctype html>
<link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css" type="text/css">
<script src="https://cdn.webix.com/edge/webix.js" type="text/javascript"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="static/script.js"></script>

<title>Hello from Flask</title>

<!-- {% if name %}
  <h1>Hello {{ name }}!</h1>
{% else %}
  <h1>Добавьте данные в бд</h1>
{% endif %} -->
<!-- <div id="tmpButton"
       style="border-style: dashed; padding: 5px 10px 5px 10px; margin: auto; width: fit-content;"
       onclick="addData()"><h3>Добавить данные в БД</h3></div> -->
<script type="text/javascript" charset="utf-8">
    webix.ready(function() {
        var myWin = webix.ui({
        view: 'window',
        head: 'Топики файла',
        modal: true,
        width: 1000,
        height: 500,
        resize: true,
        // width: "max",
        position: 'center',
        body: {
            view: 'form',
            elements: [
            {
                    "view": "datatable",
                    "columns": [{
                        id: "topic_name",
                        "header": "Название",
                        "fillspace": true,
                        "sort": "string",
                        "hidden": false
                    }, {
                        id: "msgs_type",
                        "header": "Тип сообщения",
                        "sort": "string",
                        "fillspace": true,
                        "hidden": false
                    }, {
                        id: "msgs_num",
                        "header": "Топики",
                        "sort": "string",
                        "fillspace": true,
                        "hidden": false,
                    }, {
                        id: "msgs_list",
                        "header": "Сообщения",
                        "sort": "string",
                        "fillspace": true,
                        "hidden": false,
                        // template:function(obj){ 
                        //     return "<div class='webix_el_button'><button class='webixtype_base'>Показать топики</button></div>";
                        // }
                    }],
                    "id": "topicsTable",
                    "select": true,
                    "scrollX": false,
                    "fixedRowHeight": false,
                    "multiselect": false,
                    "footer": false,
                    "checkboxRefresh": false,
                    "width": null,
                    // onClick:{
                    //     webixtype_base: function(ev, id, html){
                    //         // webix.alert("Clicked row "+id);
                    //         // myWin.show();
                    //         // $$('login').focus();
                    //     }
                    // },
                    // on: {
                    //     onBeforeLoad: function() {
                    //         this.showOverlay("Loading...");
                    //     },
                    //     onAfterLoad: function() {
                    //         this.hideOverlay();
                    //     }
                    // },

                    // url: function() {
                    //     return webix.promise(function(res) {
                    //         setTimeout(function() {
                    //             res(webix.ajax("/getFaceData", function(result) {
                    //                 result = JSON.parse(result)
                    //                 let i = 0
                    //                 for (var key in result) {
                    //                     // check if the property/key is defined in the object itself, not in parent
                    //                     // console.log(result[key]["topics_list"]) 
                    //                     console.log("load daa for table")
                    //                     $$("topicsTable").parse([{
                    //                         id: i,
                    //                         topic_name:   result[key]["filename"],
                    //                         msgs_type:   result[key]["date_creation"],
                    //                         msgs_num:   result[key]["topics_list"]
                    //                     }])
                    //                     i++
                    //                 }

                    //             }));
                    //         }, 1000)
                    //     });
                    // }
                },
            { view: 'button', value: 'Close',
                click: function (elementId, event) {
                this.getParentView().getParentView().hide();
                }
            }
            ]
        },
        move: true
        });
        grida = webix.ui({
            "rows": [{
                "view": "toolbar",
                "css": "webix_dark",
                "padding": {
                    "right": 10,
                    "left": 10
                },
                "elements": [{
                    "view": "label",
                    "label": "ROS Bags DB"
                }]
            }, {
                "type": "wide",
                "cols": [{
                    "view": "menu",
                    "width": 163,
                    layout: "y",
                    subMenuPos: "right",
                    data: [{
                        id: "1",
                        value: "Добавить..."
                    }, {
                        id: "2",
                        value: "Фильтр 7.11 more",
                        submenu: [{
                            id: "1_1",
                            value: "Дата"
                        }, {
                            id: "1_2",
                            value: "Теги"
                        }, {
                            id: "1_3",
                            value: "Размер"
                        }, {
                            id: "1_4",
                            value: "Дата"
                        }, ]
                    }, {
                        id: "3",
                        value: "Фильтр 7.11 less",
                        // submenu: ["About", "Help"]
                    }, {
                        id: "4",
                        value: "Статистика"
                    }],
                    on: {
                        onMenuItemClick: function(id) {
                            if (id == "2"){
                                webix.alert("Данные отфильтрованы по датам более поздним чем 7 ноября");
                                $$("mainTable").clearAll()
                                webix.ajax("/getFilterData", {filterItem: "data", dir: "more"}, function(result) {
                                    result = JSON.parse(result)
                                        let i = 0
                                        for (var key in result) {
                                            // check if the property/key is defined in the object itself, not in parent
                                            console.log(result[key]["topics_list"])
                                            $$("mainTable").parse([{
                                                id: i,
                                                filename:   result[key]["filename"],
                                                creation:   result[key]["date_creation"],
                                                topics:   result[key]["topics_list"],
                                                duration: result[key]["duration"]
                                            }])
                                            i++
                                        }

                                })
                            }
                            if (id == "3"){
                                webix.alert("Данные отфильтрованы по датам более ранним чем 7 ноября");
                                $$("mainTable").clearAll()
                                webix.ajax("/getFilterData", {filterItem: "data", dir: "less"}, function(result) {
                                    result = JSON.parse(result)
                                        let i = 0
                                        for (var key in result) {
                                            // check if the property/key is defined in the object itself, not in parent
                                            console.log(result[key]["topics_list"])
                                            $$("mainTable").parse([{
                                                id: i,
                                                filename:   result[key]["filename"],
                                                creation:   result[key]["date_creation"],
                                                topics:   result[key]["topics_list"],
                                                duration: result[key]["duration"]
                                            }])
                                            i++
                                        }

                                })
                            }
                            if (id == "1"){
                                webix.alert("Данные добавлены");
                                $$("mainTable").clearAll()
                                webix.ajax("/addData", function(result) {
                                    result = JSON.parse(result)
                                        let i = 0
                                        for (var key in result) {
                                            // check if the property/key is defined in the object itself, not in parent
                                            console.log(result[key]["topics_list"])
                                            $$("mainTable").parse([{
                                                id: i,
                                                filename:   result[key]["filename"],
                                                creation:   result[key]["date_creation"],
                                                topics:   result[key]["topics_list"],
                                                duration: result[key]["duration"]
                                            }])
                                            i++
                                        }

                                })
                            }
                            if (id == "4"){
                                // $$("mainTable").clearAll()
                                webix.ajax("/getStats", function(result) {
                                    result = JSON.parse(result)
                                    let text = ""
                                    for (var id in result) {
                                        text = text + result[id]["sum"] + "\n"
                                    }
                                    webix.alert({
                                        title: "Сумма значений топика quaternionTopic сообщений X",
                                        width: 400,
                                        text: text
                                });

                                })
                            }
                        },
                    }
                }, {
                    "view": "datatable",
                    "columns": [{
                        id: "filename",
                        "header": "Название",
                        "fillspace": true,
                        "sort": "string",
                        "hidden": false
                    }, {
                        id: "creation",
                        "header": "Дата создания",
                        "sort": "string",
                        "fillspace": true,
                        "hidden": false
                    }, {
                        id: "topics_list",
                        "header": "Топики",
                        "sort": "string",
                        "fillspace": true,
                        "hidden": false,
                        template:function(obj){ 
                            return "<div class='webix_el_button'><button class='webixtype_base'>Показать топики</button></div>";
                        }
                    }, {
                        id: "duration",
                        "header": "Продолжительность",
                        "sort": "string",
                        "fillspace": true,
                        "hidden": false
                    }],
                    "id": "mainTable",
                    "select": true,
                    "scrollX": false,
                    "fixedRowHeight": false,
                    "multiselect": false,
                    "footer": false,
                    "checkboxRefresh": false,
                    "width": null,
                    onClick:{
                        webixtype_base: function(ev, id, html){
                            // webix.alert("Clicked row "+id);
                            myWin.show();
                            // $$('login').focus();
                        }
                    },
                    on: {
                        onBeforeLoad: function() {
                            this.showOverlay("Loading...");
                        },
                        onAfterLoad: function() {
                            this.hideOverlay();
                        }
                    },

                    url: function() {
                        $$("mainTable").clearAll()
                        return webix.promise(function(res) {
                            setTimeout(function() {
                                res(webix.ajax("/getFaceData", function(result) {
                                    result = JSON.parse(result)
                                    console.log(result);
                                    let i = 0
                                    for (var key in result) {
                                        console.log(key)
                                        $$("mainTable").parse([{
                                            id: i,
                                            filename:   result[key]["filename"],
                                            creation:   result[key]["date_creation"],
                                              topics:   result[key]["topics_list"],
                                              duration: result[key]["duration"]
                                        }])
                                        i++
                                    }

                                }));
                            }, 1000)
                        });
                    }
                }]
            }]
        });
    })
</script>